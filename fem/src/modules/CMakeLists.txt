
INCLUDE_DIRECTORIES("${CMAKE_BINARY_DIR}/fem/src")
INCLUDE_DIRECTORIES("${CMAKE_SOURCE_DIR}/hutiter/include")

FILE(GLOB SRC_FILES *.src)

FOREACH(FNAME ${SRC_FILES})
  GET_FILENAME_COMPONENT(BASENAME ${FNAME} NAME_WE)
  ADD_CUSTOM_COMMAND(
    OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${BASENAME}.F90
    COMMAND ${CMAKE_COMMAND} -E copy ${FNAME}
      ${CMAKE_CURRENT_BINARY_DIR}/${BASENAME}.F90
    DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/${BASENAME}.src
  )
  IF(${BASENAME} STREQUAL "EliminateDirichlet")
    ADD_LIBRARY(${BASENAME} SHARED ${BASENAME}.F90)
  ELSE()
    ADD_LIBRARY(${BASENAME} MODULE ${BASENAME}.F90)
  ENDIF()

  SET_TARGET_PROPERTIES(${BASENAME} PROPERTIES PREFIX "")
  SET_TARGET_PROPERTIES(${BASENAME} PROPERTIES LINKER_LANGUAGE Fortran)
  ADD_DEPENDENCIES(${BASENAME} elmersolver)
  TARGET_LINK_LIBRARIES(${BASENAME} elmersolver)

  IF(${BASENAME} STREQUAL "EliminateDirichlet")
    IF(NOT(WIN32))
      INSTALL(TARGETS ${BASENAME} 
        ARCHIVE DESTINATION "share/elmersolver/lib"
        LIBRARY DESTINATION "share/elmersolver/lib")
    ELSE()
      INSTALL(TARGETS ${BASENAME}
        RUNTIME DESTINATION "share/elmersolver/lib"
        LIBRARY DESTINATION "share/elmersolver/lib")
    ENDIF()
  ELSE()
    INSTALL(TARGETS ${BASENAME} LIBRARY DESTINATION "share/elmersolver/lib")
  ENDIF()
ENDFOREACH()

ADD_DEPENDENCIES(EliminatePeriodic EliminateDirichlet)
TARGET_LINK_LIBRARIES(EliminatePeriodic EliminateDirichlet)
